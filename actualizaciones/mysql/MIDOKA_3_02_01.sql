
/*###############################################################################################################*/

SELECT 'ORDENES HISTORICAS';

USE MIDOKA_PGC_B;
DROP PROCEDURE IF EXISTS TRANSACCION;
DELIMITER $$
CREATE PROCEDURE TRANSACCION()
BEGIN
DECLARE _rollback BOOL DEFAULT 0;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET _rollback = 1;

START TRANSACTION;


INSERT INTO NOMBRE_MENU (nmID,nombre_nm) VALUES ('59','ORDENES HISTORICAS');

INSERT INTO SCRIPTS (scID,tipo_sc) VALUES ('33','ordenes_historicas.sh');

INSERT INTO UBICACIONES (ubID,ubicacion_ub) VALUES('21','ADMVOH');

INSERT INTO MENU (mID,nombre_m,ubicacion_m,proxubi_m,cont_m,para1_m,para2_m,para3_m,para4_m,para5_m,para6_m,para7_m) VALUES ('66','59','5','21','2','3','6','59','1','255','1','3');

INSERT INTO MENU (mID,nombre_m,ubicacion_m,proxubi_m,cont_m,para1_m,para2_m,para3_m,para4_m,para5_m,para6_m,para7_m) VALUES ('67','29','21','1','33','3','6','59','9','255','1','3');

INSERT INTO MENU (mID,nombre_m,ubicacion_m,proxubi_m,cont_m,para1_m,para2_m,para3_m,para4_m,para5_m,para6_m,para7_m) VALUES ('68','31','21','1','33','3','6','59','6','255','1','3');

CREATE TABLE IF NOT EXISTS COMPRAS (comID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,FECHA DATE,RUBRO INT NOT NULL,TIEMPO INT NOT NULL,CONSTRAINT RUBRO_COMPRA FOREIGN KEY(RUBRO) REFERENCES RUBRO (ruID) ON DELETE CASCADE ON UPDATE RESTRICT) ENGINE = InnoDB;

CREATE TABLE IF NOT EXISTS DEMANDAS (demID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,COMPRA INT NOT NULL,ARTICULO INT NOT NULL,D_REAL INT,PVENTA DOUBLE,COSTO DOUBLE,n INT,D_EST DOUBLE,d DOUBLE,METODO INT,CONFIANZA DOUBLE,REALIDAD DOUBLE,STOCK INT,VOLUMEN DOUBLE,PEDIDO INT,CONSTRAINT ID_COMPRA FOREIGN KEY (COMPRA) REFERENCES COMPRAS (comID) ON DELETE CASCADE ON UPDATE RESTRICT) ENGINE = InnoDB;

IF _rollback THEN
ROLLBACK;
SELECT 'ERROR';
ELSE
COMMIT;
END IF;
END$$
DELIMITER ;
CALL TRANSACCION;

/*###############################################################################################################*/

SELECT 'GUARDADO DE PRECIOS';

DROP PROCEDURE IF EXISTS TRANSACCION;
DELIMITER $$
CREATE PROCEDURE TRANSACCION()
BEGIN
DECLARE _rollback BOOL DEFAULT 0;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET _rollback = 1;

START TRANSACTION;

CREATE TABLE IF NOT EXISTS PRHISTORICOS (prhID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,RUBRO INT NOT NULL,CATEGORIA INT NOT NULL,MODELO INT NOT NULL,PRECIO DOUBLE NOT NULL,VIGENCIA DATE NOT NULL,CONSTRAINT CATEGORIA_PRH FOREIGN KEY (CATEGORIA) REFERENCES CATEGORIA (claID) ON DELETE CASCADE ON UPDATE RESTRICT,CONSTRAINT RUBRO_PRH FOREIGN KEY (RUBRO) REFERENCES RUBRO (ruID) ON DELETE CASCADE ON UPDATE RESTRICT,CONSTRAINT MODELO_PRH FOREIGN KEY (MODELO) REFERENCES MODELO (mdID) ON DELETE CASCADE ON UPDATE RESTRICT) ENGINE = InnoDB;

IF _rollback THEN
ROLLBACK;
SELECT 'ERROR';
ELSE
COMMIT;
END IF;
END$$
DELIMITER ;
CALL TRANSACCION;

/*###############################################################################################################*/

/*###############################################################################################################*/


SELECT 'MENU PLANIFICACION';

DROP PROCEDURE IF EXISTS TRANSACCION;
DELIMITER $$
CREATE PROCEDURE TRANSACCION()
BEGIN
DECLARE _rollback BOOL DEFAULT 0;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET _rollback = 1;

START TRANSACTION;

INSERT INTO SCRIPTS VALUES(39,'planifica_entrega.sh',NULL);

UPDATE MENU SET cont_m=39 WHERE mID=1;

UPDATE CHINO SET CUATRO='WhatsApp:15-6669-1210' WHERE chinoID=4;

IF _rollback THEN
ROLLBACK;
SELECT 'ERROR';
ELSE
COMMIT;
END IF;
END$$
DELIMITER ;
CALL TRANSACCION;


/*###############################################################################################################*/


SELECT 'CARGA STOCK Y COSTOS CSV';

DROP PROCEDURE IF EXISTS TRANSACCION;
DELIMITER $$
CREATE PROCEDURE TRANSACCION()
BEGIN
DECLARE _rollback BOOL DEFAULT 0;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET _rollback = 1;

START TRANSACTION;


INSERT INTO NOMBRE_MENU (nmID,nombre_nm) VALUES ('66','REVISION STOCK MEDIANTE CSV');

INSERT INTO SCRIPTS (scID,tipo_sc) VALUES ('40','revision_stock.sh');

INSERT INTO MENU (mID,nombre_m,ubicacion_m,proxubi_m,cont_m,para1_m,para2_m,para3_m,para4_m,para5_m,para6_m,para7_m) VALUES ('75','66','15','1','40','3','6','59','6','255','1','3');

/* ***** */

CREATE TABLE IF NOT EXISTS TIPO_REGISTRO (rcoID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,TIPO_COSTO VARCHAR(100) NOT NULL) ENGINE = InnoDB;

CREATE TABLE IF NOT EXISTS CONTABLES (contablesID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,REGISTRO DOUBLE NOT NULL,FECHA DATE NOT NULL,TIPO_REGISTRO INT NOT NULL,CONSTRAINT CATEG_CONTABLE FOREIGN KEY (TIPO_REGISTRO) REFERENCES TIPO_REGISTRO (rcoID) ON DELETE CASCADE ON UPDATE RESTRICT) ENGINE = InnoDB;

INSERT INTO TIPO_REGISTRO VALUES (1,'FIJOS'),(2,'MOVILIDAD'),(3,'INSUMOS'),(4,'COMISIONES_PABLO'),(5,'DINERO_EN_CAJA');

INSERT INTO CONTABLES VALUES (1,36000,'2018-01-01',2),(2,51891,'2018-02-01',2),(3,57333,'2018-03-01',2),(4,35703,'2018-04-01',2),(5,57541,'2018-05-01',2),(6,24761,'2017-10-07',1),(7,24761,'2017-11-07',1),(8,24761,'2017-12-07',1),(9,24761,'2017-12-07',1),(10,24761,'2018-01-01',1),(11,24761,'2018-02-01',1),(12,24761,'2018-02-01',1),(13,24761,'2018-03-01',1),(14,24761,'2018-04-01',1),(15,24761,'2018-05-01',1);

UPDATE PRHISTORICOS SET PRECIO=7.1 WHERE MODELO=75 AND PRECIO=59;

INSERT INTO NOMBRE_MENU (nmID,nombre_nm) VALUES ('67','REGISTROS CONTABLES MEDIANTE CSV');

INSERT INTO SCRIPTS (scID,tipo_sc) VALUES ('41','registros_contables.sh');

INSERT INTO MENU (mID,nombre_m,ubicacion_m,proxubi_m,cont_m,para1_m,para2_m,para3_m,para4_m,para5_m,para6_m,para7_m) VALUES ('76','67','15','1','41','3','6','59','6','255','1','3');


IF _rollback THEN
ROLLBACK;
SELECT 'ERROR';
ELSE
COMMIT;
END IF;
END$$
DELIMITER ;
CALL TRANSACCION;
