USE MIDOKA_PGC_B;SELECT * FROM (SELECT DATE_FORMAT(FECHA,'%Y-%m') AS MES,ROUND(SUM(HABER + .5 * DEVOLUCION - .03 * HABER),0) AS COBRO FROM CUENTA_CORRIENTE JOIN(OPERACIONES) ON(OPERACIONES.opID=OPERACION_REF_CC) GROUP BY DATE_FORMAT(FECHA,'%Y-%m') ORDER BY YEAR(FECHA),MONTH(FECHA) ASC) t1 LEFT JOIN (SELECT DATE_FORMAT(FECHA,'%Y-%m') AS MES,IFNULL(SUM(MONTO),0) AS COMISIONES FROM COMISIONES JOIN(OPERACIONES) ON(opID=OPERACION_REF_C) WHERE VIGENCIA IS NOT NULL AND CANCELACION IS NOT NULL AND DATE_FORMAT(FECHA,'%Y-%m') GROUP BY DATE_FORMAT(FECHA,'%Y-%m') ORDER BY DATE_FORMAT(FECHA,'%Y-%m') ASC) t2 ON(t1.MES=t2.MES) LEFT JOIN(SELECT DATE_FORMAT(OPERACIONES.FECHA,'%Y-%m') AS MES,SUM(CANTIDAD_AR*CANTIDAD_MINIMA*t1.PRECIO*(1 - IFNULL(DESCUENTO,0) / 100)) AS COSTO FROM ARMADO JOIN(PRECIOS,CATEGORIA,MODELO,CONDICION,ARTICULOS,CLIENTE,OPERACIONES,PROOVEDOR,COMISIONES) ON(opID=OPERACION_REF_C AND PRECIOS.RUBRO_pr=ARTICULOS.RUBRO AND PRECIOS.CATEGORIA_pr=ARTICULOS.CATEGORIA AND PRECIOS.MODELO_pr=ARTICULOS.MODELO AND CATEGORIA.claID=ARTICULOS.CATEGORIA AND MODELO.mdID=ARTICULOS.MODELO AND CONDICION.cdID=CLIENTE.CONDICION AND CLIENTE.clID=OPERACIONES.INTERESADO AND ARTICULOS.artID=ARMADO.ID_ARTICULO_AR AND OPERACIONES.opID=ARMADO.OPERACION_REFERENCIA_AR AND PROOVEDOR.pooID=PRECIOS.PROOVEDOR) JOIN PRHISTORICOS t1 ON(PRECIOS.RUBRO_pr=t1.RUBRO AND PRECIOS.CATEGORIA_pr=t1.CATEGORIA AND PRECIOS.MODELO_pr=t1.MODELO AND t1.VIGENCIA<=OPERACIONES.FECHA) LEFT JOIN PRHISTORICOS t2 ON(t1.RUBRO=t2.RUBRO AND t1.CATEGORIA=t2.CATEGORIA AND t1.MODELO=t2.MODELO AND t2.VIGENCIA > t1.VIGENCIA AND t2.VIGENCIA <=OPERACIONES.FECHA) WHERE t2.VIGENCIA IS NULL AND COMISIONES.VIGENCIA IS NULL AND COMISIONES.CANCELACION IS NOT NULL AND COMISIONES.TRABAJADOR=4 GROUP BY DATE_FORMAT(OPERACIONES.FECHA,'%Y-%m') ORDER BY YEAR(OPERACIONES.FECHA),MONTH(OPERACIONES.FECHA) ASC) t3 ON(t1.MES=t3.MES) LEFT JOIN(SELECT DATE_FORMAT(OPERACIONES.FECHA,'%Y-%m') AS MES,.09 * SUM(IF(DENOMINACION IS NULL,0,ROUND(IF(CONDICION = CONDICION_REFERENCIA AND DESCUENTO_ESPECIAL <> '-',1 - DESCUENTO_ESPECIAL/100 * IF(VALOR_AGREGADO>'0',(1 + VALOR_AGREGADO/100) * t1.PRECIO,t1.PRECIO) * IF(IFNULL(CANTIDAD_AR,0)>IFNULL(CANTIDAD_ING,0),CANTIDAD_AR * CANTIDAD_MINIMA,(-1 * CANTIDAD_ING) * CANTIDAD_MINIMA),IF(DESCUENTO_ESPECIFICO > '0',(1 - DESCUENTO_ESPECIFICO/100 ) * IF(VALOR_AGREGADO>'0',(1 + VALOR_AGREGADO/100) * t1.PRECIO,t1.PRECIO) * IF(IFNULL(CANTIDAD_AR,0)>IFNULL(CANTIDAD_ING,0),CANTIDAD_AR * CANTIDAD_MINIMA,(-1 * CANTIDAD_ING) * CANTIDAD_MINIMA),cond_num_cd * IF(VALOR_AGREGADO>'0',(1 + VALOR_AGREGADO/100) * t1.PRECIO,t1.PRECIO) * IF(IFNULL(CANTIDAD_AR,0)>IFNULL(CANTIDAD_ING,0),CANTIDAD_AR * CANTIDAD_MINIMA,(-1 * CANTIDAD_ING) * CANTIDAD_MINIMA))),2))) AS 'VARIABLES_ESTIMADOS' FROM ARMADO JOIN(PRECIOS,CATEGORIA,MODELO,CONDICION,ARTICULOS,CLIENTE,OPERACIONES,PROOVEDOR) ON(PRECIOS.RUBRO_pr=ARTICULOS.RUBRO AND PRECIOS.CATEGORIA_pr=ARTICULOS.CATEGORIA AND PRECIOS.MODELO_pr=ARTICULOS.MODELO AND CATEGORIA.claID=ARTICULOS.CATEGORIA AND MODELO.mdID=ARTICULOS.MODELO AND CONDICION.cdID=CLIENTE.CONDICION AND CLIENTE.clID=OPERACIONES.INTERESADO AND ARTICULOS.artID=ARMADO.ID_ARTICULO_AR AND OPERACIONES.opID=ARMADO.OPERACION_REFERENCIA_AR AND PROOVEDOR.pooID=PRECIOS.PROOVEDOR) JOIN PRHISTORICOS t1 ON(PRECIOS.RUBRO_pr=t1.RUBRO AND PRECIOS.CATEGORIA_pr=t1.CATEGORIA AND PRECIOS.MODELO_pr=t1.MODELO AND t1.VIGENCIA<=OPERACIONES.FECHA) LEFT JOIN PRHISTORICOS t2 ON(t1.RUBRO=t2.RUBRO AND t1.CATEGORIA=t2.CATEGORIA AND t1.MODELO=t2.MODELO AND t2.VIGENCIA > t1.VIGENCIA AND t2.VIGENCIA <=OPERACIONES.FECHA) WHERE t2.VIGENCIA IS NULL GROUP BY DATE_FORMAT(OPERACIONES.FECHA,'%Y-%m') ORDER BY DATE_FORMAT(OPERACIONES.FECHA,'%Y-%m') ASC) t4 ON(t4.MES=t1.MES) LEFT JOIN(SELECT DATE_FORMAT(FECHA,'%Y-%m') AS MES,SUM(COSTO) AS FIJOS FROM COSTOS WHERE TIPO_COSTO=1 GROUP BY TIPO_COSTO,DATE_FORMAT(FECHA,'%Y-%m')) t5 ON(t5.MES=t1.MES) LEFT JOIN(SELECT DATE_FORMAT(FECHA,'%Y-%m') AS MES,SUM(COSTO) AS VARIABLES FROM COSTOS WHERE TIPO_COSTO=2 GROUP BY TIPO_COSTO,DATE_FORMAT(FECHA,'%Y-%m')) t6 ON(t6.MES=t1.MES) ORDER BY t1.MES,t2.MES ASC;
