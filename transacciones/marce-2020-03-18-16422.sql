USE MIDOKA_PGC_B;
USE MIDOKA_PGC_B
DROP PROCEDURE IF EXISTS TRANSACCION;
DELIMITER $$
CREATE PROCEDURE TRANSACCION()
BEGIN
DECLARE _rollback BOOL DEFAULT 0;
DECLARE A INT;
DECLARE B INT;
DECLARE C INT;
DECLARE D INT;
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET _rollback = 1;
START TRANSACTION;
UPDATE MIDOKA_PGC_B.SOLICITUDES SET COMIENZO='2020-03-18',ASIGNADA=4 WHERE scID=36718;
UPDATE MIDOKA_PGC_B.SOLICITUDES SET REALIZACION='2020-03-18' WHERE scID=36717;
DELETE FROM MIDOKA_PGC_B.PEDIDO WHERE CANTIDAD=0;
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','119','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','2','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','20','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','21','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','22','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','23','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','26','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','29','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','30','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','32','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','33','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','34','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','56','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','73','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','74','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','75','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','76','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','77','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','80','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','81','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','86','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','58','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','71','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','93','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','95','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','113','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','270','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','247','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','251','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','253','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','254','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','287','1');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','289','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','292','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','293','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','294','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','295','0');
INSERT INTO ARMADO (OPERACION_REFERENCIA_AR,ID_ARTICULO_AR,CANTIDAD_AR) VALUES ('9466','297','0');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','119','12');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','2','12');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','20','3');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','21','3');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','22','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','23','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','26','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','29','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','30','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','32','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','33','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','34','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','56','12');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','73','18');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','74','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','75','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','76','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','77','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','80','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','81','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','86','12');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','58','10');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','71','10');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','93','18');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','95','6');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','113','48');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','270','48');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','247','3');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','251','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','253','2');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','254','3');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','289','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','292','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','293','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','294','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','295','1');
INSERT INTO FALTANTE (OPERACION_REFERENCIA_FL,ID_ARTICULO_FL,CANTIDAD_FL) VALUES ('9466','297','1');
INSERT INTO MIDOKA_PGC_B.BULTOS (OPERACION_REF,BULTOS) VALUES ('9466','1');
INSERT INTO LOCALIZACION_PEDIDO (OPERACION_REF,LOCALIZACION) VALUES ('9466','1');
DELETE FROM MIDOKA_PGC_B.ARMADO WHERE CANTIDAD_AR=0 AND CANTIDAD_EGR IS NULL AND CANTIDAD_ING IS NULL AND CANTIDAD_DEVOL IS NULL AND CANTIDAD_CST IS NULL;
UPDATE SOLICITUDES SET REALIZACION='2020-03-18' WHERE ASIGNADA=4 AND REFERENCIA=9466;
UPDATE SOLICITUDES SET COMIENZO='2020-03-18' WHERE scID=36720 AND REFERENCIA=9466;
SELECT 'ERROR' FROM BULTOS WHERE NOT EXISTS (SELECT * FROM BULTOS WHERE OPERACION_REF=9466) LIMIT 1;
SELECT 'ERROR' FROM LOCALIZACION_PEDIDO WHERE NOT EXISTS (SELECT * FROM LOCALIZACION_PEDIDO WHERE OPERACION_REF=9466) LIMIT 1;
SELECT 'ERROR' FROM ARMADO WHERE NOT EXISTS (SELECT * FROM ARMADO WHERE OPERACION_REFERENCIA_AR=9466) LIMIT 1;
SELECT COUNT(CANTIDAD_AR) FROM ARMADO WHERE OPERACION_REFERENCIA_AR=9466 INTO A;
SELECT COUNT(BULTOS) FROM BULTOS WHERE OPERACION_REF=9466 INTO B;
SELECT COUNT(LOCALIZACION) FROM LOCALIZACION_PEDIDO WHERE OPERACION_REF=9466 INTO C;
SELECT A + B + C INTO D;
IF(D < 3) THEN
SIGNAL SQLSTATE '45000';
END IF;
IF _rollback THEN
ROLLBACK;
SELECT 'ERROR';
ELSE
COMMIT;
END IF;
END$$
DELIMITER ;
CALL TRANSACCION;
